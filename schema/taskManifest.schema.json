{
    "$id": "https://wpok.dev/schema/taskManifest.schema.json",
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "WPOK Task Manifest",
    "type": "object",
    "required": ["apiVersion", "kind", "metadata", "spec"],
    "properties": {
      "apiVersion": { "type": "string", "const": "v1" },
      "kind":       { "type": "string", "const": "Task" },
      "metadata": {
        "type": "object",
        "required": ["name"],
        "properties": {
          "name":   { "type": "string", "minLength": 1 },
          "workId": { "type": "string" }
        },
        "additionalProperties": false
      },
      "spec": {
        "type": "object",
        "required": ["taskType", "executable"],
        "properties": {
          "name":       { "type": "string" },
          "taskType":   { "type": "string", "minLength": 1 },
          "executable": { "type": "string", "minLength": 1 },
          "args": {
            "type": "array",
            "items": { "type": ["string", "number", "boolean"] },
            "default": []
          },
          "work_dir":   { "type": "string" },
          "input_dir":  { "type": "string" },
          "output_dir": { "type": "string" },
  
          "inputs": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["name"],
              "properties": {
                "name":            { "type": "string", "minLength": 1 },
                "workflow_input":  { "type": "boolean", "default": true }
              },
              "additionalProperties": false
            },
            "default": []
          },
  
          "outputs": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["name"],
              "properties": {
                "name":            { "type": "string", "minLength": 1 },
                "workflow_output": { "type": "boolean", "default": true },
                "contentType":     { "type": "string" }
              },
              "additionalProperties": false
            },
            "default": []
          },
  
          "io": {
            "type": "object",
            "properties": {
              "inputs": {
                "type": "array",
                "items": {
                  "type": "object",
                  "oneOf": [
                    {
                      "title": "S3 by URL (key)",
                      "required": ["type", "url"],
                      "properties": {
                        "type": { "type": "string", "const": "s3" },
                        "url":  { "type": "string", "pattern": "^s3://[^/]+/.+[^/]$" },
                        "include": { "type": "array", "items": { "type": "string" }, "default": [] },
                        "exclude": { "type": "array", "items": { "type": "string" }, "default": [] },
                        "recursive": { "type": "boolean", "default": true },
                        "maxFiles": { "type": "integer", "minimum": 1 }
                      },
                      "additionalProperties": false
                    },
                    {
                      "title": "S3 by URL (prefix)",
                      "required": ["type", "url"],
                      "properties": {
                        "type": { "type": "string", "const": "s3" },
                        "url":  { "type": "string", "pattern": "^s3://[^/]+/.+/$" },
                        "include": { "type": "array", "items": { "type": "string" }, "default": [] },
                        "exclude": { "type": "array", "items": { "type": "string" }, "default": [] },
                        "recursive": { "type": "boolean", "default": true },
                        "maxFiles": { "type": "integer", "minimum": 1 }
                      },
                      "additionalProperties": false
                    }
                  ]
                },
                "default": []
              },
  
              "output": {
                "type": "object",
                "oneOf": [
                  {
                    "title": "S3 output by URL (prefix)",
                    "required": ["type", "url"],
                    "properties": {
                      "type": { "type": "string", "const": "s3" },
                      "url":  { "type": "string", "pattern": "^s3://[^/]+/.+/$" },
                      "overwrite": { "type": "boolean", "default": false },
                      "layout": { "type": "string" }
                    },
                    "additionalProperties": false
                  }
                ]
              },
  
              "batch": {
                "type": "object",
                "properties": {
                  "enabled":     { "type": "boolean", "default": false },
                  "grouping":    { "type": "string", "enum": ["object", "prefix"], "default": "object" },
                  "prefixDepth": { "type": "integer", "minimum": 1, "default": 1 },
                  "maxPerTask":  { "type": "integer", "minimum": 1, "default": 1 }
                },
                "additionalProperties": false,
                "default": { "enabled": false, "grouping": "object", "prefixDepth": 1, "maxPerTask": 1 }
              }
            },
            "additionalProperties": false
          }
        },
        "additionalProperties": false
      }
    },
    "additionalProperties": false
  }
  